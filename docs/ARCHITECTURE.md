# PixelHub 架构文档

## 系统概览

PixelHub 是一个基于 Go 语言开发的现代化图床应用，采用三层架构设计，提供 RESTful API 和 MCP（Model Context Protocol）接口。

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面                               │
│                    (Web / API Clients)                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP/HTTPS
                         │
┌────────────────────────▼────────────────────────────────────┐
│                      应用层 (Gin)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  图床 API    │  │   MCP API    │  │  静态文件    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │
┌────────────────────────▼────────────────────────────────────┐
│                      业务逻辑层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  图片处理    │  │  标签管理    │  │  搜索引擎    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────┬───────────────────────────────┬────────────────┘
             │                               │
             │                               │
┌────────────▼────────────┐    ┌────────────▼────────────┐
│      存储层              │    │      数据层              │
│  ┌─────────────────┐    │    │  ┌─────────────────┐    │
│  │  对象存储接口   │    │    │  │   SQLite 数据库  │    │
│  │  ┌───────────┐  │    │    │  │  ┌───────────┐  │    │
│  │  │腾讯云 COS │  │    │    │  │  │ pictures  │  │    │
│  │  └───────────┘  │    │    │  │  │   tags    │  │    │
│  │  (可扩展其他)   │    │    │  │  │picture_tags│ │    │
│  └─────────────────┘    │    │  └───────────────┘  │    │
└─────────────────────────┘    └─────────────────────┘
```

## 核心组件

### 1. 应用层 (cmd/server)

应用层是系统的入口点，负责：
- 初始化配置
- 设置路由
- 启动 HTTP 服务器
- 处理 CORS

**技术栈**：Gin Web Framework

**关键文件**：
- `cmd/server/main.go`: 主程序入口

### 2. 处理器层 (internal/handlers)

处理 HTTP 请求，进行参数验证和响应格式化。

**主要功能**：
- 图片上传处理
- 标签 CRUD 操作
- 搜索请求处理
- MCP 接口实现
- 鉴权中间件

**关键文件**：
- `internal/handlers/handler.go`: 所有 HTTP 处理器

### 3. 数据库层 (internal/database)

负责数据持久化和查询。

**数据模型**：

```
pictures (图片表)
├── id (PK)           - 图片唯一标识
├── url               - 访问 URL
├── storage_key       - 存储键
├── hash              - 文件哈希
├── upload_date       - 上传时间
└── deleted           - 软删除标记

tags (标签表)
├── id (PK)           - 标签 ID
├── tag_name (UNIQUE) - 标签名称
└── count             - 使用次数

picture_tags (关联表)
├── picture_id (FK)   - 图片 ID
└── tag_id (FK)       - 标签 ID
```

**索引设计**：
- `idx_picture_tags_picture`: 加速通过图片查找标签
- `idx_picture_tags_tag`: 加速通过标签查找图片
- `idx_tags_name`: 加速标签名称查询

**关键文件**：
- `internal/database/db.go`: 数据库初始化和表创建
- `internal/database/models.go`: 数据模型和查询方法

### 4. 存储层 (internal/storage)

抽象的存储接口，支持多种对象存储服务。

**接口设计**：
```go
type Provider interface {
    Upload(filename string, content io.Reader, contentType string) (storageKey, url string, err error)
    Delete(storageKey string) error
    GetURL(storageKey string) string
}
```

**当前实现**：
- 腾讯云 COS (Tencent Cloud Object Storage)

**扩展性**：
- 可轻松添加其他存储提供商（阿里云 OSS、AWS S3 等）
- 只需实现 `Provider` 接口

**关键文件**：
- `internal/storage/storage.go`: 存储接口定义
- `internal/storage/tencent_cos.go`: 腾讯云 COS 实现

### 5. 配置层 (internal/config)

统一的配置管理，使用 TOML 格式。

**配置项**：
- 服务器配置（主机、端口）
- MCP 配置（API Key）
- 数据库配置（路径）
- 存储配置（提供商、凭证）

**关键文件**：
- `internal/config/config.go`: 配置结构和加载

### 6. 前端 (web/)

现代化的 Web 界面，原生 JavaScript 实现。

**功能**：
- 图片上传（拖拽、点击）
- 标签管理
- 图片搜索
- 图片详情查看

**技术栈**：
- HTML5
- CSS3 (原生，使用 CSS 变量)
- JavaScript (ES6+)

**关键文件**：
- `web/index.html`: 主页面
- `web/static/css/style.css`: 样式表
- `web/static/js/app.js`: 前端逻辑

## 数据流

### 图片上传流程

```
1. 用户选择文件
   │
   ▼
2. 前端发送 multipart/form-data 请求
   │
   ▼
3. Handler 接收文件
   ├─ 计算文件哈希
   ├─ 生成图片 ID
   └─ 上传到对象存储
      │
      ▼
4. 存储成功后保存到数据库
   │
   ▼
5. 返回图片 ID 和 URL
```

### 标签搜索流程

```
1. 用户输入标签
   │
   ▼
2. 选择搜索模式 (精确/相关性)
   │
   ├─ 精确搜索 (AND)
   │  └─ SQL: WHERE picture_id IN (
   │       SELECT picture_id FROM picture_tags
   │       WHERE tag_id IN (tag_ids)
   │       GROUP BY picture_id
   │       HAVING COUNT(DISTINCT tag_id) = ?
   │     )
   │
   └─ 相关性搜索 (OR)
      └─ SQL: WHERE tag_id IN (tag_ids)
           GROUP BY picture_id
           ORDER BY COUNT(DISTINCT tag_id) DESC
   │
   ▼
3. 执行查询
   │
   ▼
4. 获取图片及其标签
   │
   ▼
5. 返回结果
```

## 性能优化

### 数据库优化

1. **索引策略**
   - 在 `picture_tags` 表创建复合索引
   - 在 `tags.tag_name` 上创建唯一索引
   - 在外键字段上创建索引

2. **查询优化**
   - 使用 JOIN 代替多次查询
   - 使用 `GROUP BY` 和 `HAVING` 优化标签搜索
   - 实现分页避免大结果集

3. **连接池**
   - SQLite 使用单连接（适合中小型应用）
   - 可考虑升级到 PostgreSQL/MySQL 以支持并发

### 存储优化

1. **CDN 加速**
   - 支持配置 CDN URL
   - 图片通过 CDN 分发

2. **文件哈希**
   - 使用 SHA-256 计算文件哈希
   - 可用于去重（未实现）

### 缓存策略（未来）

1. **标签缓存**
   - 缓存热门标签列表
   - 使用 Redis 或内存缓存

2. **搜索结果缓存**
   - 缓存常见搜索查询
   - 设置合理的过期时间

## 安全考虑

### 1. 输入验证

- 文件类型检查
- 文件大小限制
- 参数验证和清理

### 2. 鉴权

- MCP API 使用 API Key
- 图床 API 可配置鉴权（未实现）

### 3. SQL 注入防护

- 使用参数化查询
- 不直接拼接 SQL

### 4. 文件安全

- 生成唯一文件名
- 软删除机制

## 扩展性

### 水平扩展

1. **无状态设计**
   - 应用层无状态，可水平扩展
   - 使用负载均衡器分发请求

2. **数据库扩展**
   - 读写分离
   - 分片策略

3. **存储扩展**
   - 对象存储天然支持扩展
   - 多区域部署

### 垂直扩展

1. **数据库升级**
   - 从 SQLite 迁移到 PostgreSQL/MySQL
   - 更好的并发性能

2. **缓存层**
   - 添加 Redis 缓存
   - 提升查询性能

## MCP 集成

PixelHub 实现了 MCP（Model Context Protocol）接口，让 AI 应用可以：

1. **发现可用标签**
   - 了解系统中有哪些标签
   - 基于标签进行智能推荐

2. **智能搜索**
   - 根据用户描述搜索相关图片
   - 按相关性排序结果

3. **工具调用**
   - AI 可以调用 `list_tags` 工具
   - AI 可以调用 `search_images` 工具

**使用场景**：
- 聊天机器人查找相关图片
- 内容推荐系统
- 自动化图片标注

## 部署架构

### 单机部署

```
┌─────────────────────────┐
│     PixelHub Server     │
│  ┌─────────────────┐    │
│  │   Go Binary     │    │
│  ├─────────────────┤    │
│  │   SQLite DB     │    │
│  └─────────────────┘    │
└───────────┬─────────────┘
            │
            │
┌───────────▼─────────────┐
│   Tencent Cloud COS     │
└─────────────────────────┘
```

### 分布式部署

```
┌──────────────┐
│ Load Balancer│
└──────┬───────┘
       │
       ├────────────┬────────────┐
       │            │            │
┌──────▼──────┐ ┌──▼────────┐ ┌▼──────────┐
│PixelHub #1  │ │PixelHub #2│ │PixelHub #3│
└──────┬──────┘ └──┬────────┘ └┬──────────┘
       │           │            │
       └───────────┴────────────┘
                   │
       ┌───────────┴────────────┐
       │                        │
┌──────▼──────┐      ┌──────────▼─────┐
│   Database  │      │  Object Storage │
│(PostgreSQL) │      │   (Tencent COS) │
└─────────────┘      └────────────────┘
```

## 监控和日志

### 日志策略（待实现）

1. **访问日志**
   - 记录所有 API 请求
   - 包含时间、路径、状态码、耗时

2. **错误日志**
   - 记录所有错误和异常
   - 包含堆栈跟踪

3. **业务日志**
   - 图片上传记录
   - 标签操作记录

### 监控指标（待实现）

1. **系统指标**
   - CPU、内存使用率
   - 磁盘 I/O
   - 网络流量

2. **应用指标**
   - QPS（每秒查询数）
   - 响应时间
   - 错误率

3. **业务指标**
   - 图片上传数
   - 搜索次数
   - 热门标签

## 技术选型说明

### 为什么选择 Go

1. **性能**：接近 C 的性能，远超解释型语言
2. **并发**：原生支持协程，处理高并发
3. **部署**：单一二进制文件，无依赖
4. **生态**：丰富的第三方库

### 为什么选择 SQLite

1. **简单**：无需单独的数据库服务器
2. **可靠**：经过充分测试，稳定可靠
3. **适用**：适合中小型应用（每日 10 万次查询内）
4. **可迁移**：后期可轻松迁移到 PostgreSQL/MySQL

### 为什么选择对象存储

1. **可靠性**：多副本存储，高可用
2. **扩展性**：无限容量
3. **成本**：按使用量付费
4. **性能**：CDN 加速

## 未来规划

### 短期（1-3 个月）

- [ ] 添加用户认证和授权
- [ ] 实现图片去重功能
- [ ] 添加缩略图生成
- [ ] 支持图片批量操作
- [ ] 完善错误处理和日志

### 中期（3-6 个月）

- [ ] 实现 Redis 缓存
- [ ] 支持更多存储提供商
- [ ] 添加图片编辑功能
- [ ] 实现图片分享功能
- [ ] 添加监控和告警

### 长期（6-12 个月）

- [ ] 迁移到 PostgreSQL
- [ ] 实现微服务架构
- [ ] 添加 AI 图片标注
- [ ] 支持视频存储
- [ ] 开发移动端应用

